<div data-id="leave-wrapper">

</div>


<!--退学 入口模板-->
<script type="text/template" id="leave-entry-tpl">
  <!--申请退学 状态-->
  {{if type}}
    <div class="main-box">
      <div class="wrap-box clearfix">
        <div class="main">
          <div class="bg-white border-e0e0e0">
            <div class="teacher_title border-bottom" style="background: #f4f4f4;">
              <a class="btn btn-normal btn-gray fr" href="/logout" data-id="logout">
                <i class="icon icon-175x0 margin_r5"></i>退出登录
              </a>
              <h2><i class="icon icon-35x32"></i>申请退学</h2>
            </div>
            <div id="tabs-content-box" class="padding20">
              {{include 'leave-entry-sub-tpl'}}
            </div>
          </div>
        </div>
      </div>
    </div>
  {{else}}
    {{include 'leave-entry-sub-tpl'}}
  {{/if}}
</script>
  <script type="text/template" id="leave-entry-sub-tpl">
    <div class="padding10" data-id="leave-box">
      <table width="100%" height="400" class="text-center">
        <tr>
          <td valign="middle">
            
            <p>
              <i class="loading"></i>
              </p>
              <p class="font22 gray margin_t10">数据加载中...</p>
          </td>
        </tr>
      </table>
    </div>
  </script>

<!--退学协议书-->
<script type="text/template" id="leave-agreement-tpl">
  {{if author==1}}
    <h4 class="text-center">退学协议书</h4>
    <div class="border-e0e0e0 padding20 margin_t20 center-block" style="width:70%;">
      学员自愿申请退学，经本人申请，学院审核，符合退学条件者方可准予正式退学。<br><br>
      （1）学生一经注册，第一学期不办理退学、转学手续<br>
      （2）学院审核通过退学申请后，正式开始退学<br>
      （3）提交申请退学后，将不能进行学习，可撤销退学申请，恢复学习<br>
      （4）正式退学后，已注册学籍信息将不能在学信网查询<br>
      （5）学生符合转学、退学条件，经批准后，按规定标准退还费用，具体请查看<a href="#" class="text-orange" data-download="file"><u>《国家开放大学退学退费规定》</u></a>
    </div>
    <div class="text-center margin_t10">
      <label data-id="agree">
        <input type="checkbox">
        本人已阅读，并清楚知道退学协议内容和规定
      </label>
    </div>
    <div class="text-center margin-t30">
      <button class="btn btn-lg disabled" disabled style="width:200px;" data-role="apply-leave">申请退学</button>
    </div>
  {{else}}
    <div class="margin_t25">
        <table style="margin:0 auto;">
          <tr>
            <td valign="top" class="padding_r10"><i class="alert-icon alert-icon-0x0"></i></td>
            <td>
              <div class="font32 text-orange line-height-1">
                退学申请窗口期未到！
              </div>
              <div style="line-height:1.4" class="font_gray_per60 margin_t10">
                申请退学需要在规则时间内进行，请留意相关开放时间！
              </div>
            </td>
          </tr>
        </table>
        <div class="margin-t30 text-center">
          <button type="button" class="btn btn-lg btn-white margin_r10 f14" style="width:150px;" onclick="history.back();">返回</button>
          <button type="button" class="btn btn-lg f14 btn-orange" data-role="ee-contact" style="width:150px;">我有疑问</button>
        </div>
      </div>
  {{/if}}
</script>

<!--申请退学-->
<script type="text/template" id="leave-agreement-apply-tpl">
  <form class="theform">
    {{include 'person-info-temp' baseInfo}}

    <div class="margin-t30">
      <div class="text-no-bold sub-title f16 margin_b10">
        银行卡信息
        <span class="f12 text-orange">此信息仅用于退还退学后剩余费用，银行卡姓名必须与学籍姓名一致！</span>
      </div>
      <table class="table-gray-th">
          <colgroup>
            <col width="10%"></col>
            <col width="22%"></col>

            <col width="10%"></col>
            <col width="22%"></col>

            <col width="10%"></col>
            <col width="22%"></col>
          </colgroup>
          <tbody>
              <tr>
                <th class="text-right">退费方式</th>
                <td colspan="5">转账</td>
              </tr>
              <tr>
                <th class="text-right">银行卡号</th>
                <td>
                  <div class="valid-control">
                    <input class="form-control form-control-block" type="text" placeholder="请填写您的银行卡卡号" name="bankCardNumber" datatype="*" nullmsg="请填写您的银行卡卡号" errormsg="请填写您的银行卡卡号">
                  </div>
                </td>

                <th class="text-right">帐户名</th>
                <td>{{baseInfo.data.info.xm}}</td>

                <th class="text-right">开户银行</th>
                <td>
                  <div class="valid-control">
                    <select class="form-control form-control-block" data-id="bank-select" name="openBank" datatype="*" nullmsg="请选择开户银行" errormsg="请选择开户银行">
                      <option value=''>请选择开户银行</option>
                    </select>
                  </div>
                </td>
              </tr>
          </tbody>
      </table>
      <div class="margin_t5 text-orange f12">
        退学应扣、应退费用将严格按照国家规定执行，具体请查看
        <a href="#" class="text-orange" data-download="file"><u>《国家开放大学退学退费规定》</u></a>
      </div>
    </div>

    <div class="margin-t30">
      <div class="text-no-bold sub-title f16 margin_b10">退学原因</div>
      <div class="valid-control">
        <textarea id="editor4" rows="10" class="form-control form-control-block" name="cause" datatype="*" nullmsg="请填写原因" errormsg="请填写原因" style="resize: none;"></textarea>
      </div>
    </div>

    {{include 'confirm-sign-temp'}}

    <div class="text-center margin-t30">
      <button type="submit" class="btn btn-lg btn-orange" style="width:200px;">提交申请</button>
    </div>
  </form>
</script>

<!--申请退学 结果-->
<script type="text/template" id="leave-agreement-details-tpl">
    {{if otherInfo.transactionStatus==12}}
      <div class="padding_b20 border-bottom margin_b25">
        <table style="margin:0 auto;">
          <tr>
            <td valign="top" class="padding_r10"><i class="alert-icon alert-icon-56x0"></i></td>
            <td>
              <div class="font32 text-green line-height-1">
                已正式退学，不能再进行学习！
              </div>
              <div style="line-height:1.4" class="font_gray_per60 margin_t10">
                你已完成退学申请，正式退学，不能再进行学习！
              </div>
            </td>
          </tr>
        </table>
      </div>
    {{else}}

      <div class="padding_b20 border-bottom margin_b25">
        <table style="margin:0 auto;">
          <tr>
            <td valign="top" class="padding_r10"><i class="alert-icon alert-icon-0x0"></i></td>
            <td>
              <div class="font32 text-orange line-height-1">
                已提交退学申请，请等待处理！
              </div>
              <div style="line-height:1.4" class="font_gray_per60 margin_t10">
                你已提交退学申请，申请期间将不能进行学习，如想恢复学习可撤销退学申请<br>退学申请完成后，将正式退学，不能再登录学习！
              </div>
            </td>
          </tr>
        </table>
      </div>
    {{/if}}
    

    <div class="clearfix">
      <div class="subnav_btn fl" data-role="type-tab" style="border-bottom: 0 none;">
        <a href="#" style="border-bottom: 1px #e0e0e0 solid;">退学申请</a>
        <a href="#" class="active" style="border-bottom: #fff 1px solid;">审核流程</a>
      </div>
    </div>

    <div class="clearfix border-e0e0e0" style="margin-top: -1px;">
      <div data-role="tab-cnt" style="display:none;">
        <div class="padding15">
          {{include 'person-info-temp' baseInfo}}

          <div class="margin-t30">
            <div class="text-no-bold sub-title f16 margin_b10">
              银行卡信息
            </div>
            <table class="table-gray-th">
                <colgroup>
                  <col width="10%">
                  <col width="22%">

                  <col width="10%">
                  <col width="22%">

                  <col width="10%">
                  <col width="22%">
                </colgroup>
                <tbody>
                    <tr>
                      <th class="text-right">退费方式</th>
                      <td colspan="5">转账</td>
                    </tr>
                    <tr>
                      <th class="text-right">银行卡号</th>
                      <td>
                        {{otherInfo.dropOutStudyInfo.bankCardNumber}}
                      </td>

                      <th class="text-right">帐户名</th>
                      <td>{{baseInfo.data.info.xm}}</td>

                      <th class="text-right">开户银行</th>
                      <td>
                        {{otherInfo.dropOutStudyInfo.openBank}}
                      </td>
                    </tr>
                </tbody>
            </table>
          </div>
          <div class="margin-t30">
            <div class="text-no-bold sub-title f16 margin_b10">退学原因</div>
            <div class="border-e0e0e0 padding20">
              {{otherInfo.dropOutStudyInfo.cause}}
            </div>
          </div>

          <div class="margin-t30">
            <div class="text-no-bold sub-title f16">签名确认</div>
            <table class="table-gray-th text-center margin_t10" height="350">
                <tr>
                  <td valign="middle">

                      {{if otherInfo.isApplyFor==1 && otherInfo.dropOutStudyInfo && otherInfo.dropOutStudyInfo.sign}}
                        <div data-id="qrcode-pic-box">
                          <img src="{{(otherInfo.dropOutStudyInfo && otherInfo.dropOutStudyInfo.sign)?otherInfo.dropOutStudyInfo.sign:''}}" style="max-width:100%">
                        </div>
                      {{else}}
                        <div class="f16">
                            您的还未签名
                        </div>
                      {{/if}}
                  </td>
                </tr>
              </table>
          </div>

        </div>
      </div>
      <div data-role="tab-cnt">
        <div class="padding15">
          {{if otherInfo.outStudyAuditList && otherInfo.outStudyAuditList.length>0}}
            <div class="logistics-box logistics-box-2">
              {{each otherInfo.outStudyAuditList}}
                <dl class="{{($index==otherInfo.outStudyAuditList.length-1)?'last':''}}">
                  {{if $value.auditOperatoRole==-1}}
                    <dt>{{baseInfo.data.info.xm}}（学员） <small>{{$value.auditDt}}</small></dt>
                    <dd class="static gray">学员申请</dd>
                    <dd class="icon-order"></dd>
                  {{else if ($value.auditOperatoRole==2 || $value.auditOperatoRole==4 || $value.auditOperatoRole==5) && $value.auditState==0}}
                    <dt>退学申请等待受理</dt>
                    <dd class="static gray">待受理</dd>
                    <dd class="icon-order"></dd>
                  {{else if $value.auditOperatoRole==5 && $value.auditState==1}}
                    <dt>退学申请已受理 <small>{{$value.auditDt}}</small></dt>
                    <dd class="static text-green">已受理</dd>
                    <dd class="icon-order icon-order-green"></dd>
                  {{else if $value.auditOperatoRole==6 && $value.auditState==6}}
                    <dt>财务服务部待核算实收、应扣、应退费用</dt>
                    <dd class="static gray">待核算</dd>
                    <dd class="icon-order"></dd>
                  {{else if $value.auditOperatoRole==6 && $value.auditState==7}}
                    <dt>财务服务部已核算实收、应扣、应退费用 <small>{{$value.auditDt}}</small></dt>
                    <dd class="static text-green">已核算</dd>
                    <dd class="icon-order icon-order-green"></dd>
                  {{else if $value.auditOperatoRole==1 && $value.auditState==8}}
                    <dt>学员待确认应扣、应退金额</dt>
                    <dd class="static text-orange">待确认</dd>
                    <dd class="icon-order icon-order-orange"></dd>
                    <dd class="message">
                      <div class="border-e0e0e0 padding10 margin_t5">
                          <div>
                            请确认应扣、应退费用，如有疑问可点击“我有疑问”按钮提问题！
                          </div>
                          <table class="table-gray-th text-center f12 margin_t10">
                            <thead>
                              <tr>
                                <th>专业</th>
                                <th>学费</th>
                                <th>实收费用</th>
                                <th>应扣费用</th>
                                <th>应退费用</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td>
                                  <ul class="list-unstyled text-left">
                                    <li>专业名称：{{baseInfo.data.info.specialtyName}}</li>
                                    <li>专业层次：{{baseInfo.data.info.pyccName}}</li>
                                    <li>报读学期：{{baseInfo.data.info.gradeName}}</li>
                                  </ul>
                                </td>
                                <td>
                                  <ul class="list-unstyled text-left">
                                    <li>原价：{{otherInfo.transCostMap.originalPrice}}元</li>
                                    <li>优惠：{{otherInfo.transCostMap.reducedPrice}}元</li>
                                    <li>应缴：{{otherInfo.transCostMap.payablePrice}}元</li>
                                    <li>已缴：{{otherInfo.transCostMap.paidinPrice}}</li>
                                  </ul>
                                </td>
                                <td>{{otherInfo.transCostMap.receivedPrice}}元</td>
                                <td>
                                  <ul class="list-unstyled text-left text-orange">
                                    <li>学籍注册费：{{otherInfo.transCostMap.rollRegisterPrice}}元</li>
                                    <li>网络通讯费：{{otherInfo.transCostMap.networkMessagePrice}}元</li>
                                    <li>学习费：{{otherInfo.transCostMap.studyPrice}}元</li>
                                    <li>教材费：{{otherInfo.transCostMap.shouldTextbookPrice}}元</li>
                                    <li>合计：{{otherInfo.transCostMap.totalPrice}}元</li>
                                  </ul>
                                </td>
                                <td>{{otherInfo.transCostMap.shouldBackPrice}}元</td>
                              </tr>
                            </tbody>
                          </table>
                          <div class="margin_t5 text-orange f12">
                            退学应扣、应退费用将严格按照国家规定执行，具体请查看
                            <a href="#" class="text-orange" data-download="file">
                              <u>《国家开放大学退学退费规定》</u>
                            </a>
                          </div>
                          <div class="text-right margin_t10">
                            <button type="button" class="btn btn-md btn-orange min-width-120 f14 margin_r5" data-role="ee-contact">我有疑问</button>
                            <button type="button" class="btn btn-md btn-green min-width-120 f14" data-role="confirm-amount" data-transactionid="{{otherInfo.transactionId}}">确认应扣、应退金额</button>
                          </div>
                      </div>
                    </dd>
                  {{else if $value.auditOperatoRole==1 && $value.auditState==9}}
                    <dt>学员已确认应扣、应退金额 <small>{{$value.auditDt}}</small></dt>
                    <dd class="static text-green">已确认</dd>
                    <dd class="icon-order icon-order-green"></dd>
                    <dd class="message">
                      <div class="border-e0e0e0 padding10 margin_t5">
                          <table class="table-gray-th text-center f12">
                            <thead>
                              <tr>
                                <th>专业</th>
                                <th>学费</th>
                                <th>实收费用</th>
                                <th>应扣费用</th>
                                <th>应退费用</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td>
                                  <ul class="list-unstyled text-left">
                                    <li>专业名称：{{baseInfo.data.info.specialtyName}}</li>
                                    <li>专业层次：{{baseInfo.data.info.pyccName}}</li>
                                    <li>报读学期：{{baseInfo.data.info.gradeName}}</li>
                                  </ul>
                                </td>
                                <td>
                                  <ul class="list-unstyled text-left">
                                    <li>原价：{{otherInfo.transCostMap.originalPrice}}元</li>
                                    <li>优惠：{{otherInfo.transCostMap.reducedPrice}}元</li>
                                    <li>应缴：{{otherInfo.transCostMap.payablePrice}}元</li>
                                    <li>已缴：{{otherInfo.transCostMap.paidinPrice}}</li>
                                  </ul>
                                </td>
                                <td>{{otherInfo.transCostMap.receivedPrice}}元</td>
                                <td>
                                  <ul class="list-unstyled text-left text-orange">
                                    <li>学籍注册费：{{otherInfo.transCostMap.rollRegisterPrice}}元</li>
                                    <li>网络通讯费：{{otherInfo.transCostMap.networkMessagePrice}}元</li>
                                    <li>学习费：{{otherInfo.transCostMap.studyPrice}}元</li>
                                    <li>教材费：{{otherInfo.transCostMap.shouldTextbookPrice}}元</li>
                                    <li>合计：{{otherInfo.transCostMap.totalPrice}}元</li>
                                  </ul>
                                </td>
                                <td>{{otherInfo.transCostMap.shouldBackPrice}}元</td>
                              </tr>
                            </tbody>
                          </table>
                          <div class="margin_t5 text-orange f12">
                            退学应扣、应退费用将严格按照国家规定执行，具体请查看
                            <a href="#" class="text-orange" data-download="file">
                              <u>《国家开放大学退学退费规定》</u>
                            </a>
                          </div>
                      </div>
                    </dd>
                  {{else if $value.auditOperatoRole==0 && $value.auditState==8}}
                    <dt>院长确认退学</dt>
                    <dd class="static gray">待处理</dd>
                    <dd class="icon-order"></dd>
                  {{else if $value.auditOperatoRole==0 && $value.auditState==9}}
                    <dt>院长已确认退学</dt>
                    <dd class="static text-green">已确认</dd>
                    <dd class="icon-order icon-order-green"></dd>
                    <dd class="message">
                      <div class="border-e0e0e0 padding10 margin_t5">
                        <div>
                          确认意见：
                          <div class="margin_t5">
                            {{$value.auditContent}}
                          </div>
                        </div>
                        <div class="margin_t10 text-right gray">
                          院长：{{$value.auditOperator}}<br>
                          {{$value.auditDt}}
                        </div>
                      </div>
                    </dd>
                  {{else if $value.auditOperatoRole==7 && $value.auditState==10}}
                    <dt>待退款</dt>
                    <dd class="static gray">待退款</dd>
                    <dd class="icon-order"></dd>
                  {{else if $value.auditOperatoRole==7 && $value.auditState==11}}
                    <dt>已退款 <small>{{$value.auditDt}}</small></dt>
                    <dd class="static text-green">已退款</dd>
                    <dd class="icon-order icon-order-green"></dd>
                    <dd class="message">
                      <div class="border-e0e0e0 padding10 margin_t5">
                        <div>
                          {{$value.auditContent}}<br>
                          点击查看
                          <a href="{{otherInfo.transCostMap.backPriceVoucher}}" class="text-blue" data-role="view-cert"><u>退费凭证</u></a>
                        </div>
                        <div class="text-right margin_t10">
                          <button type="button" class="btn btn-md btn-orange min-width-120 f14" data-role="ee-contact">我有疑问</button>
                        </div>
                      </div>
                    </dd>
                  {{else if $value.auditOperatoRole==5 && $value.auditState==8}}
                    <dt>学籍科确认退学</dt>
                    <dd class="static gray">待处理</dd>
                    <dd class="icon-order"></dd>
                  {{else if $value.auditOperatoRole==5 && $value.auditState==9}}
                    <dt>学籍科已确认退学</dt>
                    <dd class="static text-green">已确认退学</dd>
                    <dd class="icon-order icon-order-green"></dd>
                    <dd class="message">
                      <div class="border-e0e0e0 padding10 margin_t5">
                        <div>
                          确认意见：
                          <div class="margin_t5">
                            {{$value.auditContent}}
                          </div>
                          {{if otherInfo.dropOutStudyInfo.dropSchoolPhoto}}
                            <div class="margin_t10">
                              <span class="p-win-cert">
                                <img class="vertical-middle" src="{{otherInfo.dropOutStudyInfo.dropSchoolPhoto | imgUrlFormat:[160,100]}}" width="160" height="100">
                                <a href="{{otherInfo.dropOutStudyInfo.dropSchoolPhoto}}" class="light-box" data-role="fancybox">点击放大</a>
                              </span>
                            </div>
                          {{/if}}
                        </div>
                        <div class="margin_t10 text-right gray">
                          学籍科：{{$value.auditOperator}}<br>
                          {{$value.auditDt}}
                        </div>
                      </div>
                    </dd>
                  {{else if $value.auditState==12}}
                    <dt>{{baseInfo.data.info.xm}}（学员）已退学 <small>{{$value.auditDt}}</small></dt>
                    <dd class="static gray">完成退学</dd>
                    <dd class="icon-order"></dd>
                  {{/if}}
                </dl>
              {{/each}}
            </div>
          {{/if}}
        </div>
      </div>
    </div>
    {{if otherInfo.dropOutStudyInfo.revocation!=1}}
      {{if otherInfo.transactionStatus!=13}}
        <div style="
          position:fixed;
          bottom:0;
          left:0;
          width:100%;
          background:#fafafa;
          background:rgba(250, 250, 250, 0.85);
        ">
          <div class="padding25 text-center">
            <button type="button" class="btn btn-lg btn-orange" data-role="re-apply" data-transactionid="{{otherInfo.transactionId}}">撤销退学申请，恢复学习</button>
          </div>
        </div>
      {{/if}}
    {{/if}}
</script>

<!--个人信息 模板-->
<script type="text/template" id="person-info-temp">
  <div>
    <div class="text-no-bold sub-title f16 margin_b10">个人信息</div>
    <table class="table-gray-th">
        <tbody>
          {{if msgCode==200}}
            {{if data && data.info}}
              <tr>
                <th width="10%" class="text-right">姓名</th>
                <td width="22%">{{data.info.xm}}</td>

                <th width="10%" class="text-right">专业</th>
                <td>{{data.info.specialtyName}}（{{data.info.ruleCode}}）</td>

                <th width="10%" class="text-right">层次</th>
                <td width="20%">{{data.info.pyccName}}</td>
              </tr>
              <tr>
                <th class="text-right">身份证</th>
                <td>{{data.info.sfzh}}</td>

                <th class="text-right">年级</th>
                <td>{{data.info.yearName}}</td>

                <th class="text-right">学期</th>
                <td>{{data.info.gradeName}}</td>
              </tr>
            {{else}}
              <tr>
                <td>
                  <div class="text-center padding20">
                      <i class="alert-icon alert-icon-123x63"></i>
                      <span class="f14">无数据</span>
                  </div>
                </td>
              </tr>
            {{/if}}
          {{else}}
            <tr>
              <td>
                <div class="text-center padding20">
                    <i class="alert-icon alert-icon-123x63"></i>
                    <span class="f14">{{message}}</span>
                </div>
              </td>
            </tr>
          {{/if}}
        </tbody>
    </table>
  </div>
</script>

<!--签名确认 模板-->
<script type="text/template" id="confirm-sign-temp">
  <div class="margin-t30">
    <div class="text-no-bold sub-title f16">签名确认</div>
    <table class="table-gray-th text-center margin_t10" height="350">
        <tr>
          <td valign="middle">
            <div class="valid-control">

                
                <div id="sign-qrcode" class="margin_b10">
                  <i class="loading"></i>
                </div>

                <div class="f16" data-id="sign-tips">
                    请用手机扫一扫入您的电子签名
                </div>

                <button type="button" class="btn btn-lg btn-orange border-radius min-width-120" data-role="create-qrcode" style="display:none;">重新签名</button>

                <input class="form-control form-control-block" type="hidden" datatype="*" nullmsg="请签名" errormsg="请签名" name="sign">
              
              <div class="tooltip yellow_tip t_arrow tooltip-valid" style="margin-bottom:10px;left:47%;"><div class="tooltip-in text-nowrap"></div><span class="t_arrow"><i class="arrow"></i><i class="arrow arrow_inner"></i></span></div>
            </div>
          </td>
        </tr>
      </table>
  </div>
</script>

<script type="text/javascript">
require(['jquery','artTemplate','common','jquery.qrcode'], function ($,template) {
  var $wrapper=$('[data-id="leave-wrapper"]');

  $wrapper.html( 
    template('leave-entry-tpl',
      {type:appJSON.isApplyLeavingSchool}
    ) 
  );


  var $container=$('[data-id="leave-box"]');
  var loading=$('[data-role="page-loading"]');

  //查看大图
  require(['jquery.fancybox'],function(){
    $('[data-role="fancybox"]').fancybox();
  });

  function getBaseInfo(){
    return ajaxProcess({
      //接口 1.1 学籍基本资料
      url:'/pcenter/roll/getBaseInfo',
      type:'GET',
      success:function(renderData){
        //缓存学生学籍信息
        appJSON.studentRecordInfo=renderData;
      },
      fail:function(XMLHttpRequest, textStatus){
          $container.html(template('error-tips-temp',{message:textStatus}));
      }
    });
  }

  ajaxProcess({
    url:'/pcenter/roll/transaction/studentOutStudyApplication',//1.24 校验学员是否有申请退学资格
    type:'GET',
    success:function(authorApplyData){
      if(authorApplyData.msgCode==200 && authorApplyData.data){
        //0:不能申请退学 1:可以申请退学
        if(authorApplyData.data.isApplication==1){
          ajaxProcess({
            url:'/pcenter/roll/transaction/getDropOutStudyAudit',//1.20 查看异动退学详情
            type:'GET',
            data:{transactionType:4},
            success:function(json){
              var jsonData=json.data;
              if(json.msgCode==200 && jsonData){
                //是否为{}对象
                if(!jsonData.transactionId){
                  $container.html( template('leave-agreement-tpl',{author:1}) );
                }
                else{
                  function renderHtml(baseInfo){
                    var render=template.compile($('#leave-agreement-details-tpl').html(),{escape:false})
                    $container.html(render(
                      {
                        baseInfo:baseInfo,
                        otherInfo:jsonData,
                      }
                    ));
                  }

                  if(appJSON.studentRecordInfo){
                    renderHtml(appJSON.studentRecordInfo);
                  }
                  else{
                    getBaseInfo()
                    .done(function(renderData){
                      appJSON.studentRecordInfo=renderData;
                      renderHtml(renderData);
                    })
                    .fail(function(XMLHttpRequest, textStatus){
                        $container.html(template('error-tips-temp',{message:textStatus}));
                    });
                  }
                }
              }
              else{
                $container.html(template('error-tips-temp',{message:json.message}));
              }
            },
            fail:function(errorMsg){
              $container.html(template('error-tips-temp',{message:errorMsg}));
            }
          });
        }
        else{
          $container.html( template('leave-agreement-tpl',{author:0}) );
        }
      }
      else{
        $container.html(template('error-tips-temp',{message:authorApplyData.message}));
      }
    },
    fail:function(errorMsg){
      $container.html(template('error-tips-temp',{message:errorMsg}));
    }
  });

  
  $container
  //同意“退学协议书”
  .on('click', '[data-id="agree"]', function(event) {
    var $input=$(this).children('input');
    if($input.prop('checked')){
      $('[data-role="apply-leave"]').prop('disabled', false).removeClass('disabled').addClass('btn-orange');
    }
    else{
      $('[data-role="apply-leave"]').prop('disabled', true).addClass('disabled').removeClass('btn-orange');
    }
  })

  //申请
  .on('click', '[data-role="apply-leave"]', function(event) {
    var def=$.Deferred();
    if(appJSON.studentRecordInfo){
      def.resolve(appJSON.studentRecordInfo);
    }
    else{
      loading.show();

      getBaseInfo()
      .done(function(renderData){
          appJSON.studentRecordInfo=renderData;
          def.resolve(renderData);
      })
      .always(function(){
        loading.hide();
      });
    }

    def.done(function(renderData){
        $container.html( template('leave-agreement-apply-tpl',{
            baseInfo:renderData
          })
        );

        $(window).scrollTop(0);

        createQrcode();

        //表单验证
        initValidForm($(".theform",$container), function() {
            var curform = this;
            loading.show();

            ajaxProcess({
                //1.18 学籍异动退学申请
                url: '/pcenter/roll/transaction/dropOutStudy',
                type: 'POST',
                data: curform.serialize(),
                success: function(data) {
                    if (data.msgCode == 200) {
                        $.when($.resultDialog(1, '提交成功')).done(function() {
                            //curRoute.app.refresh();
                            location.reload();
                        });
                    } else {
                        $.resultDialog(1, data.message);
                    }
                },
                fail: function(errorMsg) {
                    $.resultDialog(2, '提交失败', 2000);
                },
                always: function() {
                    loading.hide();
                }
            });
        });

        ajaxProcess({
            //1.19 学籍异动获取银行名称列表
            url: '/pcenter/roll/transaction/getBankInfo',
            type: 'GET',
            success: function(bankData) {
                if (bankData.msgCode == 200 && bankData.data) {
                  var render=template.compile('\
                    {{each bankMap}}\
                      <option>{{$value}}</option>\
                    {{/each}}\
                  ');

                  var html=render(bankData.data);
                  $('[data-id="bank-select"]',$container).append(html);
                }
            }
        });
    });
 
  })
  //撤销申请退学
  .on('click', '[data-role="re-apply"]', function(event) {
    var transactionId=$(this).data('transactionid');
    
    var $pop=$.alertDialog({
        width:340,
        height:270,
        content:[
          '<i class="alert-icon alert-icon-0x0 margin_r10"></i>',
            '<span class="font18 text-orange vertical-middle inline-block">确定要撤销申请退学？</span>'
        ].join(''),
        okCss:'btn btn-normal btn-orange margin_l15 min-width-100',
        cancelCss:'btn btn-normal btn-gray min-width-100',
        ok:function(){
          loading.show();
          ajaxProcess({
              //1.23 学员撤销退学申请
              url: '/pcenter/roll/transaction/studentRevocation',
              type: 'POST',
              data: {transactionId:transactionId},
              success: function(data) {
                  if (data.msgCode == 200) {
                      $.when($.resultDialog(1, '提交成功')).done(function() {

                          appJSON.isApplyLeavingSchool=false;
                          setTimeout(function(){
                            location.reload();
                          },0);

                          curRoute.redirect('#/xjyidong');
                      });
                  } else {
                      $.resultDialog(1, data.message);
                  }
              },
              fail: function(errorMsg) {
                  $.resultDialog(2, '提交失败', 2000);
              },
              always: function() {
                  loading.hide();
              }
          });

          $.closeDialog(this);
        }
    });
  })

  //选项卡
  .on('click', '[data-role="type-tab"] a', function(event) {
    event.preventDefault();
    var index=$(this).index();
    $(this).addClass('active').css('border-bottom-color', '#fff')
    .siblings().removeClass('active').css('border-bottom-color', '#e0e0e0');
    $('[data-role="tab-cnt"]').eq(index).show().siblings().hide();
  })
  //确认应扣、应退金额
  .on('click', '[data-role="confirm-amount"]', function(event) {
    var transactionId=$(this).data('transactionid');
    
    $.alertDialog({
        id:'confirm-amount',
        width:340,
        height:270,
        content:[
          '<i class="alert-icon alert-icon-0x0 margin_r10"></i>',
            '<span class="font18 text-orange vertical-middle inline-block">我已确认退学应扣、应退金额</span>'
        ].join(''),
        okCss:'btn btn-normal btn-orange margin_l15 min-width-100',
        cancelCss:'btn btn-normal btn-gray min-width-100',
        ok:function(){
          loading.show();
          ajaxProcess({
            url:'/pcenter/roll/transaction/studentConfirmCost',//1.21 异动退学--学员确认应扣、应退金额
            type:'POST',
            data:{transactionId:transactionId},
            success:function(json){
              if(json.msgCode==200){
                $.when($.resultDialog(1, '提交成功')).done(function() {
                    curRoute.app.refresh();
                });
              }
              else{
                $.resultDialog(1, json.message);
              }
            },
            fail:function(errorMsg){
              $.resultDialog(2, '提交失败', 2000);
            },
            always: function() {
                $('[data-role="page-loading"]').hide();
                loading.hide();
            }
          });

          $.closeDialog(this);
        }
    });
  })
  //查看退款凭证
  .on('click', '[data-role="view-cert"]', function(event) {
    event.preventDefault();
    var imgURL=$(this).attr('href');
    if(imgURL){
      var w=650,h=480;
      $.alertDialog({
          title:'查看退款凭证',
          id:'confirm-amount',
          width:w,
          height:h,
          content:'<img class="vertical-middle" src="'+imgURL+'" style="max-width:'+(w-20)+'px;max-height:'+(h-52-36-20)+'px;">',
          cancelLabel:'关闭',
          cancelCss:'btn btn-normal btn-gray min-width-100',
          okLabel:'下载',
          okCss:'btn btn-normal btn-orange margin_l15 min-width-100',
          ok:function(){
            window.open(imgURL);
            $.closeDialog(this);
          }
      });
    }
  })
  //点击生成二维码
  .on('click','[data-role="create-qrcode"]',function(event) {
    createQrcode();
  })

  //查看/下载退学退费规定文件
  .on('click', '[data-download="file"]:not([disabled])', function(event) {
    event.preventDefault();
    var _this=this;

    $(this).attr('disabled', '').append('<span class="gray">文件获取中...</span>');

    var winOpen=window.open('about:blank','download');

    winOpen.document.write('\
        <div>文件加载中...<\/div>\
        <script>\
          setTimeout("window.close()",800);\
        <\/script>\
    ');

    ajaxProcess({
        url:'/pcenter/roll/transaction/getOutStudyTemplate',
        type:'GET',
        success:function(json){
            if(json.msgCode==200 && json.data && json.data.link){
              window.open(json.data.link,'download');
            }
            else{
              $.resultDialog(2,'文件获取失败:'+json.message);
            }
        },
        fail:function(errorMessage){
            $.resultDialog(2,'文件获取失败:'+errorMessage);
        },
        always:function(){
          $(_this).removeAttr('disabled').children('span').remove();
        }
    });
  });

  //生成二维码
  function createQrcode(){
    var $qrcodePic=$('[data-id="qrcode-pic-box"]',$container)
    var $createBtn=$('[data-role="create-qrcode"]',$container);
    var $signQrcod=$('#sign-qrcode',$container);
    var $signTips=$('[data-id="sign-tips"]',$container);

    if($createBtn.data('recreate')){
      $signTips.show();
      $createBtn.hide();
    }

    if(!$createBtn.data('recreate')){
      $createBtn.hide().data('recreate',true);
    }

    $createBtn.prop('disabled',true).addClass('disabled').text('二维码生成中...')

    $signQrcod.html('<i class="loading"></i>');
    $signTips.hide();

    //获取签名二维码
    ajaxProcess({
      url:'/pcenter/qrcode/getToken',
      type:'GET',
      success:function(data){
        //清除计时器
        $.each(window['timerCollectors'], function(i, e) {
          if(e){
            clearInterval(e);
          }
        });         
        if( data.data && data.data.obj){
          $createBtn.prop('disabled',false).removeClass('disabled').text('重新签名');
          $qrcodePic.hide();
          $signTips.show();
          //如果是IE8及以下的IE浏览器，使用table渲染类型
          var qrcodeRenderType=($('html').hasClass('ie8') || $('html').hasClass('ie67'))?"table":"canvas";

          //console.log('http://'+location.host+'/pcenter/qrcode/mobile-signup.html?token='+(data.data.obj))

          $signQrcod.empty().qrcode({
            render : qrcodeRenderType,
            width : 230,
            height : 230,
            text  : 'http://'+location.host+'/pcenter/qrcode/mobile-signup.html?token='+(data.data.obj)
          }).show();

          // 每隔1秒检测是否签名
          var signInt = setInterval(function () {
            // 获取当前时间戳(以s为单位)
            var timestamp = Date.parse(new Date());
            timestamp = timestamp / 1000;
            
            ajaxProcess({
              url:'/pcenter/qrcode/signCheck',
              type:'GET',
              data:{token:data.data.obj,timestamp:timestamp},
              success:function(data){
                if(data.data && data.data.obj) {
                    clearInterval(signInt); 
                    $('[name="sign"]',$container).val(data.data.obj).next('.tooltip').hide();
                    $signQrcod.html('<img src="'+data.data.obj+'" style="max-width:100%;">');
                    $signTips.hide();
                    $createBtn.show();
                }
              }
            })
          }, 1000);

          window['timerCollectors'].push(signInt);
        }
      },
      fail:function(error){
        $createBtn.prop('disabled',false).removeClass('disabled').text('二维码生成出错，重新生成');
        //清除计时器
        $.each(window['timerCollectors'], function(i, e) {
          if(e){
            clearInterval(e);
          }
        });
      }
    });
  }
  
});
</script>